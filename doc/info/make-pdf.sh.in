#!/bin/sh

usage () {
    echo "make-pdf.sh [-Dh?] texifile"
    echo "    -D   Enable simple debugging of this script"
    echo "    -h   This help"
    echo "    -?   This help too"
    echo "  texifile  File to be converted to PDF"
    echo ""
    echo "Create a pdf file from the given texi file"
    exit 1
}

while getopts "Dh?" arg
do
  case $arg in
      D) DEBUG=yes ;;
      h) usage ;;
      \?) usage ;;
  esac
done

shift `expr $OPTIND - 1`

TEXIFILE=$1
BASEFILE=`basename $TEXIFILE .texi`
INTERACTION="-interaction=nonstopmode"
build () {
    pdftex -etex $INTERACTION $TEXIFILE
    if [ $? -ne 0 ]; then
	exit 1
    fi
    @SED@ --in-place=bak -E 's/^(.*)\{([^!]+)!([^}]+)\}[ ]*$$/\1{\2}{\3}/' $BASEFILE.dc
    ./texindex $BASEFILE.??
}

if [ "$DEBUG" = "yes" ]; then
set -x
fi

build
while ( grep 'you must run TeX again' $BASEFILE.log ); do
    build
done
